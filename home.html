<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>مسجل الشاشة مع المايك</title>
<style>
body { font-family: Arial; background:#f0f2f5; display:flex; justify-content:center; align-items:center; height:100vh; }
.container { background:#fff; padding:20px 30px; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.2); text-align:center; width:450px; }
h2 { margin-bottom:20px; }
.controls { display:grid; gap:15px; margin-bottom:20px; }
select, button, label { padding:10px; font-size:15px; border-radius:8px; border:1px solid #ccc; width:100%; }
button { cursor:pointer; background:#007bff; color:#fff; border:none; transition:0.3s; }
button:hover { background:#0056b3; }
#stopBtn { background:#dc3545; } #stopBtn:hover { background:#a71d2a; }
video { margin-top:15px; width:100%; border-radius:10px; border:1px solid #ddd; }
</style>
</head>
<body>
<div class="container">
<h2>📹 مسجل الشاشة مع المايك</h2>
<div class="controls">
<label><input type="checkbox" id="fullScreen"> تسجيل Full Screen بأعلى جودة</label>
<label><input type="checkbox" id="withMic"> 🎤 تسجيل مع المايك</label>
<button id="startBtn">▶️ بدء التسجيل</button>
<button id="stopBtn" disabled>⏹️ إيقاف التسجيل</button>
</div>
<video id="preview" controls autoplay muted></video>
</div>

<script>
let mediaRecorder, recordedChunks = [], finalStream, isRecording=false;

async function startRecording() {
    if(isRecording) return;
    const fullScreen = document.getElementById("fullScreen").checked;
    const withMic = document.getElementById("withMic").checked;

    let constraints = fullScreen ? { video: { width: screen.width, height: screen.height, frameRate:60 } } :
                                   { video: { width:1280, height:720, frameRate:30 } };

    try {
        const displayStream = await navigator.mediaDevices.getDisplayMedia(constraints);
        let tracks = [...displayStream.getVideoTracks()];
        
        if(withMic){
            const micStream = await navigator.mediaDevices.getUserMedia({ audio:true });
            // دمج الصوت باستخدام AudioContext لضمان تسجيل المايك
            const audioContext = new AudioContext();
            const destination = audioContext.createMediaStreamDestination();
            const systemSource = audioContext.createMediaStreamSource(displayStream);
            const micSource = audioContext.createMediaStreamSource(micStream);
            systemSource.connect(destination);
            micSource.connect(destination);
            tracks.push(...destination.stream.getAudioTracks());
        } else if(displayStream.getAudioTracks().length>0){
            tracks.push(...displayStream.getAudioTracks());
        }

        finalStream = new MediaStream(tracks);
        document.getElementById("preview").srcObject = finalStream;

        let mimeType = "video/mp4";
        if(!MediaRecorder.isTypeSupported(mimeType)) mimeType="video/webm;codecs=vp9";

        mediaRecorder = new MediaRecorder(finalStream, { mimeType:mimeType, videoBitsPerSecond:10000000, audioBitsPerSecond:320000 });
        mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = saveRecording;

        // التعامل مع إيقاف التسجيل عند إغلاق أي Track
        finalStream.getTracks().forEach(track=>{
            track.onended=()=>{ if(isRecording) stopRecording(); }
        });

        mediaRecorder.start();
        isRecording=true;
        document.getElementById("startBtn").disabled=true;
        document.getElementById("stopBtn").disabled=false;

    } catch(err){
        alert("فشل البدء: "+err.message);
    }
}

function stopRecording() {
    if(!isRecording) return;
    isRecording=false;
    if(mediaRecorder && mediaRecorder.state!=="inactive") mediaRecorder.stop();
    document.getElementById("startBtn").disabled=false;
    document.getElementById("stopBtn").disabled=true;
}

async function saveRecording(){
    const blob = new Blob(recordedChunks, { type: mediaRecorder.mimeType });
    recordedChunks=[];
    
    if(window.showSaveFilePicker){
        try{
            const handle = await window.showSaveFilePicker({
                suggestedName:"تسجيل_الشاشة.mp4",
                types:[{description:"Video File", accept:{[mediaRecorder.mimeType]:[".mp4"]}}]
            });
            const writable = await handle.createWritable();
            await writable.write(blob);
            await writable.close();
        }catch(err){ console.log("تم الإلغاء", err); }
    } else {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download="تسجيل_الشاشة.mp4";
        a.click();
    }
}

document.getElementById("startBtn").onclick = startRecording;
document.getElementById("stopBtn").onclick = stopRecording;
</script>
</body>
</html>











